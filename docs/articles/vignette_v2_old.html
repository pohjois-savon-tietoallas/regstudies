<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Use cases of 'regstudies' R package • regstudies</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Use cases of 'regstudies' R package">
<meta property="og:description" content="regstudies">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">regstudies</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example.html">Example of regstudies workflow</a>
    </li>
    <li>
      <a href="../articles/vignette_v2_old.html">Use cases of 'regstudies' R package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Use cases of ‘regstudies’ R package</h1>
                        <h4 class="author">Juho Kopra</h4>
            
            <h4 class="date">2020-06-04</h4>
      
      
      <div class="hidden name"><code>vignette_v2_old.Rmd</code></div>

    </div>

    
    
<div id="how-to-use" class="section level3">
<h3 class="hasAnchor">
<a href="#how-to-use" class="anchor"></a>How to use</h3>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">regstudies</span>)
<span class="co"># read cohort data</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">vroom</span>)
<span class="no">cohort</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vroom/man/vroom.html">vroom</a></span>(<span class="st">"./datas/fake_cohort.csv"</span>)
<span class="no">cohort</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()
<span class="co"># personid: id for each individual in the study</span>
<span class="co"># postingdate: date of interest to find comorbidities</span>
<span class="co"># status: some kind of additional data ???</span>

<span class="co"># prepare some register data:</span>
<span class="no">reg</span><span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/vroom/man/vroom.html">vroom</a></span>(<span class="kw">file</span><span class="kw">=</span><span class="st">"./datas/ostpre_hilmo_9616_dgt_eng.csv"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">lubridate</span>)
<span class="no">reg</span><span class="kw">&lt;-</span><span class="no">reg</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">admissiondate</span><span class="kw">=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">dmy</a></span>(<span class="no">admissiondate</span>),<span class="kw">dischargedate</span><span class="kw">=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">dmy</a></span>(<span class="no">dischargedate</span>))
<span class="no">reg</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()

<span class="co"># lets calculate if the code is icd-8, icd-9 or icd-10</span>
<span class="no">reg</span><span class="kw">&lt;-</span><span class="no">reg</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">icd</span><span class="kw">=</span><span class="fu">case_when</span>( <span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">dischargedate</span>)<span class="kw">&lt;</span><span class="fl">1987</span> ~ <span class="st">"icd8"</span>,
                        <span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">dischargedate</span>)<span class="kw">&lt;</span><span class="fl">1996</span> <span class="kw">&amp;</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">dischargedate</span>)<span class="kw">&gt;=</span><span class="fl">1987</span> ~ <span class="st">"icd9"</span>,
                        <span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">dischargedate</span>)<span class="kw">&gt;=</span><span class="fl">1996</span> ~ <span class="st">"icd10"</span>
                      )
        ) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">startletter</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">regexpr</a></span>(<span class="kw">pattern</span><span class="kw">=</span><span class="st">"^[A-Z]"</span>,<span class="no">CODE1</span>)<span class="kw">&gt;</span><span class="fl">0</span>)
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">reg</span>$<span class="no">icd</span>,<span class="no">reg</span>$<span class="no">startletter</span>) <span class="co"># These data does not contain ICD-9 diagnostics codes. Only ICD-10.</span></pre></body></html></div>
</div>
<div id="loading-a-code-classification-definition-from-excel-file" class="section level1">
<h1 class="hasAnchor">
<a href="#loading-a-code-classification-definition-from-excel-file" class="anchor"></a>Loading a code classification definition from Excel file</h1>
<p>Okay, so in this phase we load data from Excel file and modify it to suit the needs or regstudies package. It may be easier to ask your collaborate researchers to fill an Excel file with suitable diagnose codes (e.g. ICD-codes) with an asterix symbol of “%” in this case. The function ‘make_regex’ can be used to tranform these LIKE% codes to regural expression definitions automatically.</p>
<div class="sourceCode"><html><body><pre class="r">
<span class="co"># We load classification here</span>
<span class="no">excelfile</span> <span class="kw">&lt;-</span> <span class="kw pkg">readxl</span><span class="kw ns">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span>(<span class="st">"./datas/disease_classification.xlsx"</span>)
<span class="no">cl9</span> <span class="kw">&lt;-</span> <span class="no">excelfile</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/make_regex.html">make_regex</a></span>(<span class="kw">classname</span><span class="kw">=</span><span class="no">Lyhenne</span>,<span class="kw">diagnosis</span><span class="kw">=</span><span class="no">sairdiag_icd9</span>,<span class="kw">diagnosis.rm</span><span class="kw">=</span><span class="no">sairdiagpl_icd9</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">icd</span><span class="kw">=</span><span class="st">"icd9"</span>)
<span class="no">cl10</span> <span class="kw">&lt;-</span> <span class="no">excelfile</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/make_regex.html">make_regex</a></span>(<span class="kw">classname</span><span class="kw">=</span><span class="no">Lyhenne</span>,<span class="kw">diagnosis</span><span class="kw">=</span><span class="no">sairdiag</span>,<span class="kw">diagnosis.rm</span><span class="kw">=</span><span class="no">sairdiagpl</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">icd</span><span class="kw">=</span><span class="st">"icd10"</span>)

<span class="no">sel_classes</span><span class="kw">&lt;-</span><span class="fu">bind_rows</span>(<span class="no">cl9</span>,<span class="no">cl10</span>) <span class="kw">%&gt;%</span>
              <span class="fu">mutate</span>(<span class="kw">classification</span><span class="kw">=</span><span class="st">"own_definition"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="kw">list</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cl9"</span>,<span class="st">"cl10"</span>))</pre></body></html></div>
<div class="sourceCode"><html><body><pre class="r">
<span class="no">tbclasses</span><span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/vroom/man/vroom.html">vroom</a></span>(<span class="st">"./datas/pois/charlson_and_elixhauser_classifications.csv"</span>)
<span class="no">tbclasses</span> <span class="kw">&lt;-</span> <span class="no">tbclasses</span> <span class="kw">%&gt;%</span>
  <span class="fu">rename</span>(<span class="kw">label</span><span class="kw">=</span><span class="no">class</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">regex.rm</span><span class="kw">=</span><span class="fl">NA_character_</span>)<span class="co"># %&gt;%</span>

<span class="co"># to understand the structure of tbclasses</span>
<span class="no">tbclasses</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>()
<span class="no">tbclasses</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()

<span class="co"># following classifications are available:</span>
<span class="no">tbclasses</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">classification</span>) <span class="kw">%&gt;%</span> <span class="fu">distinct</span>()
<span class="co"># we select the classification to be "elixhauser"</span>
<span class="no">sel_classes</span> <span class="kw">&lt;-</span> <span class="no">tbclasses</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">classification</span><span class="kw">==</span><span class="st">"elixhauser"</span>)</pre></body></html></div>
<p>Next we will join the registerdata ‘reg’ to cohort data. Then we will search data within two years range from ‘indexdate’. It is enough that either ‘admissiondate’ or ‘dischargedate’ is within the interval.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># we want to find out the diseases within 2 years before and after the study date 'postingdate'</span>
<span class="no">regintvl</span><span class="kw">&lt;-</span><span class="no">cohort</span> <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">reg</span> <span class="kw">%&gt;%</span> <span class="fu">select</span>(<span class="no">personid</span>,<span class="no">CODE1</span>,<span class="no">admissiondate</span>,<span class="no">dischargedate</span>,<span class="no">icd</span>),<span class="kw">by</span><span class="kw">=</span><span class="st">"personid"</span>) <span class="kw">%&gt;%</span> <span class="co"># join the datas</span>
  <span class="fu">mutate</span>(<span class="kw">indexdate</span><span class="kw">=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="no">postingdate</span>)) <span class="kw">%&gt;%</span> <span class="co"># 1. compute indexdate names 'indexdate'</span>
  <span class="fu">mutate</span>(<span class="kw">timeinterval</span><span class="kw">=</span> (<span class="no">indexdate</span>-<span class="fu"><a href="http://lubridate.tidyverse.org/reference/period.html">years</a></span>(<span class="fl">2</span>)) <span class="kw">%--%</span> (<span class="no">indexdate</span>+<span class="fu"><a href="http://lubridate.tidyverse.org/reference/period.html">years</a></span>(<span class="fl">2</span>)) ) <span class="kw">%&gt;%</span> <span class="co"># 2. create an interval out of 'indexdate'</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">dischargedate</span> <span class="kw">%within%</span> <span class="no">timeinterval</span> <span class="kw">|</span> <span class="no">admissiondate</span> <span class="kw">%within%</span> <span class="no">timeinterval</span>) <span class="co"># 3. filtering</span></pre></body></html></div>
<p>So that is one way of doing that. By using the function ‘datefilter’ from regstudies package the code becomes a bit cleaner. The function also allows arbitrary number of date variable to be entered in the filtering.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">regintvl</span><span class="kw">&lt;-</span><span class="no">cohort</span> <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">reg</span> <span class="kw">%&gt;%</span> <span class="fu">select</span>(<span class="no">personid</span>,<span class="no">CODE1</span>,<span class="no">admissiondate</span>,<span class="no">dischargedate</span>,<span class="no">icd</span>),<span class="kw">by</span><span class="kw">=</span><span class="st">"personid"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">postingdate</span><span class="kw">=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="no">postingdate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">datefilter</span>(<span class="kw">indexdate</span><span class="kw">=</span><span class="no">postingdate</span>,<span class="kw">range</span><span class="kw">=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/period.html">years</a></span>(<span class="fl">2</span>),<span class="no">admissiondate</span>,<span class="no">dischargedate</span>) <span class="co"># filtering the diagnosis codes which are in the interval for each individual!</span></pre></body></html></div>
<p>Alright, now we use function called ‘classify’ to make classification table out of diagnosis codes. The sel_classes is the object used for classification. This function will create as many new variables as there are class definitions. So the data will be wide! These data can be joined to register data using ‘left_join’!</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># remind me, what is in sel_classes?</span>
<span class="no">sel_classes</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">classification</span>) <span class="kw">%&gt;%</span> <span class="fu">distinct</span>()
<span class="no">ltout</span> <span class="kw">&lt;-</span> <span class="fu">classify</span>(<span class="no">regintvl</span>,<span class="kw">icdcodes</span><span class="kw">=</span><span class="no">CODE1</span>,<span class="kw">diag_tbl</span><span class="kw">=</span><span class="no">sel_classes</span>) <span class="co"># with exceptions</span>
<span class="no">ltout</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()</pre></body></html></div>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># next, we calculate the table which can be used for classification</span>
<span class="no">ltout</span><span class="kw">&lt;-</span><span class="no">cohort</span> <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">reg</span> <span class="kw">%&gt;%</span> <span class="fu">select</span>(<span class="no">personid</span>,<span class="no">CODE1</span>,<span class="no">admissiondate</span>,<span class="no">dischargedate</span>),<span class="kw">by</span><span class="kw">=</span><span class="st">"personid"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">postingdate</span><span class="kw">=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="no">postingdate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_date.html">filter_date</a></span>(<span class="kw">indexdate</span><span class="kw">=</span><span class="no">postingdate</span>,<span class="kw">range</span><span class="kw">=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/period.html">years</a></span>(<span class="fl">2</span>),<span class="no">admissiondate</span>,<span class="no">dischargedate</span>) <span class="kw">%&gt;%</span> <span class="co"># filterin the diagnosis codes which are in the interval for each individual!</span>
  <span class="fu">classify_long</span>(<span class="kw">icdcodes</span><span class="kw">=</span><span class="no">CODE1</span>,<span class="kw">diag_tbl</span><span class="kw">=</span><span class="no">sel_classes</span>)
<span class="no">ltout</span>
<span class="no">ltout</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>()
<span class="co"># now we can utilise the table</span>
<span class="co"># 'regintvl' is the data from registers to contain only the events withing +-2 year period interval</span>
<span class="co"># it also contains only the events for individuals in 'cohort'</span>

<span class="no">dat</span><span class="kw">&lt;-</span><span class="no">cohort</span> <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">reg</span> <span class="kw">%&gt;%</span> <span class="fu">select</span>(<span class="no">personid</span>,<span class="no">CODE1</span>,<span class="no">admissiondate</span>,<span class="no">dischargedate</span>,<span class="no">icd</span>),<span class="kw">by</span><span class="kw">=</span><span class="st">"personid"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">postingdate</span><span class="kw">=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="no">postingdate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_date.html">filter_date</a></span>(<span class="kw">indexdate</span><span class="kw">=</span><span class="no">postingdate</span>,<span class="kw">range</span><span class="kw">=</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/period.html">years</a></span>(<span class="fl">2</span>),<span class="no">admissiondate</span>,<span class="no">dischargedate</span>) <span class="kw">%&gt;%</span>
  <span class="fu">classify_data_long</span>(<span class="kw">icdcodes</span><span class="kw">=</span><span class="no">CODE1</span>,<span class="kw">diag_tbl</span><span class="kw">=</span><span class="no">sel_classes</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">match</span><span class="kw">&gt;</span><span class="fl">0</span>)</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Juho Kopra, Jani Miettinen, Reijo Sund.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
